name: Create Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Which version bump (patch, minor, major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

jobs:
  create-bump-pr:
    name: Create bump PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate base branch (only master or release/* allowed)
        id: validate
        shell: bash
        run: |
          BASE="${{ github.ref_name }}"
          echo "Validating base branch: $BASE"
          if [[ ! "$BASE" =~ ^master$ ]] && [[ ! "$BASE" =~ ^release\/.+$ ]]; then
            echo "ERROR: workflow may only be dispatched from 'master' or a 'release/*' branch. Selected: $BASE"
            exit 1
          fi
          echo "ok=true" >> $GITHUB_OUTPUT

      - name: Compute automation branch name
        id: names
        run: |
          ts=$(date +"%Y%m%d-%H%M%S")
          auto_branch="automation/release-bump-${ts}"
          echo "auto_branch=${auto_branch}" >> $GITHUB_OUTPUT
          echo "automation branch: ${auto_branch}"

      - name: Create temporary branch and bump version
        uses: ./.github/action/bump-npm-version
        with:
          bump: ${{ inputs.bump }}
          token: ${{ secrets.GIT_CLI_ADMIN_TOKEN }}
          repository: ${{ github.repository }}
          branch: ${{ steps.names.outputs.auto_branch }}

      - name: Open PR from temporary branch -> master
        env:
          GH_TOKEN: ${{ secrets.GIT_CLI_ADMIN_TOKEN }}
        run: |
          auto_branch="${{ steps.names.outputs.auto_branch }}"
          gh pr create \
            --repo "${{ github.repository }}" \
            --base master \
            --head "${auto_branch}" \
            --title "[Release] Bump version - automated" \
            --body "Automated version bump (created by Create Release workflow). Please review and merge."
